# Docker Compose for Marketdata Collector + Uploader + HourMM Trading System
#
# Deployment on VPS:
#   1. Clone repo to /home/luis/marketdata/repo
#   2. Copy deploy/prod.env to /home/luis/marketdata/secrets/prod.env
#   3. Run: docker compose up -d
#
# Data is stored in a named volume 'marketdata' mounted at /data in both containers.
# HourMM journal data stored in 'hourmm_journal' volume.

services:
  collector:
    build:
      context: ./collector
      dockerfile: Dockerfile
    container_name: marketdata-collector
    restart: unless-stopped
    volumes:
      - marketdata:/data
    environment:
      - COLLECTOR_DATA_DIR=/data
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    networks:
      - default

  uploader:
    build:
      context: ./uploader
      dockerfile: Dockerfile
    container_name: marketdata-uploader
    restart: unless-stopped
    volumes:
      - marketdata:/data
    env_file:
      - ./deploy/prod.env
    depends_on:
      - collector
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    networks:
      - default

  # ============================================
  # HourMM Trading System
  # ============================================

  # Container A: Binance Pricer
  # Ingests Binance data, computes features, produces fair prices
  binance_pricer:
    build:
      context: .
      dockerfile: services/binance_pricer/Dockerfile
    container_name: hourmm-binance-pricer
    restart: unless-stopped
    environment:
      - BINANCE_SYMBOL=BTCUSDT
      - HTTP_HOST=0.0.0.0
      - HTTP_PORT=8080
      - STALE_THRESHOLD_MS=500
      - SNAPSHOT_PUBLISH_HZ=50
      - LOG_LEVEL=INFO
    ports:
      # Internal only - not exposed to host
      - "8080"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    networks:
      - hourmm

  # Container B: Polymarket Trader
  # Trading logic, risk management, order execution
  polymarket_trader:
    build:
      context: .
      dockerfile: services/polymarket_trader/Dockerfile
    container_name: hourmm-polymarket-trader
    restart: unless-stopped
    volumes:
      - hourmm_journal:/data
    environment:
      - POLL_SNAPSHOT_HZ=50
      - SNAPSHOT_URL=http://binance_pricer:8080/snapshot/latest
      - GAMMA_API_URL=https://gamma-api.polymarket.com
      - MARKET_SLUG=bitcoin-up-or-down
      - SQLITE_PATH=/data/journal.db
      - CONTROL_HOST=0.0.0.0
      - CONTROL_PORT=9000
      - LOG_LEVEL=INFO
      # Risk limits (from prod.env, adjust as needed)
      # Note: these are overridden by prod.env if set there
      - MAX_RESERVED_CAPITAL=5.0
      - MAX_POSITION_SIZE=5.0
      - MAX_ORDER_SIZE=5.0
      - MAX_OPEN_ORDERS=4
      # Session timers (in ms)
      - T_WIND_MS=600000
      - T_FLATTEN_MS=300000
      - HARD_CUTOFF_MS=60000
    env_file:
      - ./deploy/prod.env  # For PM_API_KEY, PM_API_SECRET, PM_PASSPHRASE, PM_PRIVATE_KEY
    ports:
      # Control plane - bind to localhost only for operator access
      - "127.0.0.1:9000:9000"
    depends_on:
      binance_pricer:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:9000/status')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    networks:
      - hourmm

volumes:
  marketdata:
    driver: local
    # On VPS, you can bind to a specific path:
    # driver_opts:
    #   type: none
    #   o: bind
    #   device: /home/luis/marketdata/data
  
  # HourMM journal volume for SQLite persistence
  hourmm_journal:
    driver: local

networks:
  default:
    driver: bridge
  
  # Dedicated network for HourMM containers
  hourmm:
    driver: bridge
